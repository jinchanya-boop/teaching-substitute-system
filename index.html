<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกการสอนแทน - โรงเรียนสา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .signature-pad {
            border: 2px solid #3b82f6;
            border-radius: 8px;
            cursor: crosshair;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            touch-action: none;
        }

        // PDF Generation function
        function generatePDF(recordId) {
            var record = records.find(function(r) { return r.id === recordId; });
            if (!record) {
                showNotification('ไม่พบข้อมูลที่ต้องการพิมพ์', 'error');
                return;
            }

            if (record.status !== 'completed' || record.adminApproval !== 'approved') {
                showNotification('สามารถพิมพ์ PDF ได้เฉพาะเอกสารที่อนุมัติครบทุกขั้นตอนแล้วเท่านั้น', 'error');
                return;
            }

            // Create PDF content
            var pdfContent = createPDFContent(record);
            
            // Open in new window for printing
            var printWindow = window.open('', '_blank');
            printWindow.document.write(pdfContent);
            printWindow.document.close();
            
            // Auto print after content loads
            printWindow.onload = function() {
                printWindow.print();
            };
        }

        function createPDFContent(record) {
            var currentDate = new Date().toLocaleDateString('th-TH');
            
            return `
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เอกสารบันทึกการสอนแทน - ${record.subject}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Sarabun', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        
        .school-name {
            font-size: 24px;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 5px;
        }
        
        .document-title {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        
        .document-id {
            font-size: 14px;
            color: #6b7280;
        }
        
        .content-section {
            margin-bottom: 25px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
            padding-bottom: 5px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: #111827;
            font-size: 14px;
            border-bottom: 1px dotted #d1d5db;
            padding-bottom: 3px;
            min-height: 20px;
        }
        
        .content-area {
            margin-top: 15px;
        }
        
        .content-text {
            background-color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
            margin-bottom: 10px;
        }
        
        .approval-section {
            background-color: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .approval-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .approval-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #e0e7ff;
            border-radius: 6px;
            background-color: white;
        }
        
        .approval-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
        }
        
        .approval-status {
            color: #059669;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .approval-date {
            font-size: 12px;
            color: #6b7280;
        }
        
        .signature-box {
            border: 1px solid #d1d5db;
            height: 80px;
            margin: 10px 0;
            border-radius: 4px;
            background-color: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 12px;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }
        
        .print-date {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: #6b7280;
        }
        
        @media print {
            body { margin: 0; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="print-date">พิมพ์เมื่อ: ${currentDate}</div>
    
    <div class="header">
        <div class="school-name">โรงเรียนสา</div>
        <div class="document-title">เอกสารบันทึกการสอนแทน</div>
        <div class="document-id">เลขที่เอกสาร: ${record.id}</div>
    </div>

    <div class="content-section">
        <div class="section-title">ข้อมูลการมอบหมายงาน</div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">วันที่สอนแทน:</div>
                <div class="info-value">${record.date || 'ไม่ระบุ'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">เวลา:</div>
                <div class="info-value">${record.time || 'ไม่ระบุ'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">ชั้น/ห้อง:</div>
                <div class="info-value">${record.classRoom || 'ไม่ระบุ'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">วิชา:</div>
                <div class="info-value">${record.subject || 'ไม่ระบุ'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">ครูประจำวิชา:</div>
                <div class="info-value">${record.regularTeacher || 'ไม่ระบุ'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">ครูสอนแทน:</div>
                <div class="info-value">${record.substituteTeacher || 'ไม่ระบุ'}</div>
            </div>
        </div>
        
        <div class="content-area">
            <div class="info-label">เนื้อหาที่สอน:</div>
            <div class="content-text">${record.content || 'ไม่ระบุ'}</div>
            
            <div class="info-label">กิจกรรมการเรียนการสอน:</div>
            <div class="content-text">${record.activities || 'ไม่ระบุ'}</div>
            
            <div class="info-label">การบ้าน:</div>
            <div class="content-text">${record.homework || 'ไม่มี'}</div>
        </div>
    </div>

    ${record.substituteReport ? `
    <div class="content-section">
        <div class="section-title">รายงานผลการสอนจากครูสอนแทน</div>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">จำนวนนักเรียนที่เข้าเรียน:</div>
                <div class="info-value">${record.substituteReport.attendance || 'ไม่ระบุ'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">พฤติกรรมของนักเรียน:</div>
                <div class="info-value">${record.substituteReport.behavior || 'ไม่ระบุ'}</div>
            </div>
        </div>
        <div class="info-label">ข้อสังเกตเพิ่มเติม:</div>
        <div class="content-text">${record.substituteReport.observations || 'ไม่มี'}</div>
    </div>
    ` : ''}

    <div class="approval-section">
        <div class="section-title">การอนุมัติ</div>
        <div class="approval-grid">
            <div class="approval-item">
                <div class="approval-title">ครูประจำวิชา</div>
                <div class="approval-status">✓ มอบหมาย</div>
                <div class="signature-box">ลายเซ็นครูประจำวิชา</div>
                <div class="approval-date">${record.createdAt || ''}</div>
            </div>
            
            <div class="approval-item">
                <div class="approval-title">หัวหน้าสาระ</div>
                <div class="approval-status">✓ อนุมัติ</div>
                <div class="signature-box">ลายเซ็นหัวหน้าสาระ</div>
                <div class="approval-date">${record.headReason || ''}</div>
            </div>
            
            <div class="approval-item">
                <div class="approval-title">รองกลุ่มบริหาร</div>
                <div class="approval-status">✓ อนุมัติขั้นสุดท้าย</div>
                <div class="signature-box">ลายเซ็นรองกลุ่มบริหาร</div>
                <div class="approval-date">${record.finalApprovalDate || ''}</div>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <div class="info-label">เหตุผลการอนุมัติจากรองกลุ่มบริหาร:</div>
            <div class="content-text">${record.adminReason || 'ไม่ระบุ'}</div>
        </div>
    </div>

    <div class="footer">
        <div>เอกสารนี้ออกโดยระบบบันทึกการสอนแทน - โรงเรียนสา</div>
        <div>สถานะ: อนุมัติครบทุกขั้นตอนแล้ว | วันที่สร้างเอกสาร: ${currentDate}</div>
    </div>
</body>
</html>`;
        }
        .signature-pad:hover {
            border-color: #1d4ed8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .signature-pad.drawing {
            border-color: #10b981;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background-color: #10b981;
            color: white;
        }
        .notification.error {
            background-color: #ef4444;
            color: white;
        }
        .notification.info {
            background-color: #3b82f6;
            color: white;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .record-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-pending { border-left: 4px solid #f59e0b; }
        .status-approved { border-left: 4px solid #10b981; }
        .status-rejected { border-left: 4px solid #ef4444; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://img2.pic.in.th/pic/sa1.png" alt="โลโก้โรงเรียน" class="h-16 w-16 object-contain">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">ระบบบันทึกการสอนแทน</h1>
                        <p class="text-gray-600">งานเทคโนโลยี - โรงเรียนสา</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="showLogin()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                        เข้าสู่ระบบ
                    </button>
                    <button onclick="showDashboard()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        แดชบอร์ด
                    </button>
                    <button onclick="showSettings()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        ⚙️ ตั้งค่า
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Menu Selection -->
        <div id="menuSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow cursor-pointer" onclick="showTeacherForm()">
                <div class="text-center">
                    <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">👨‍🏫</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">ครูประจำวิชา</h3>
                    <p class="text-gray-600 text-sm">มอบหมายงานสอนแทน</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow cursor-pointer" onclick="showHeadForm()">
                <div class="text-center">
                    <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">👩‍💼</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">หัวหน้าสาระ</h3>
                    <p class="text-gray-600 text-sm">พิจารณาอนุมัติ</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow cursor-pointer" onclick="showSubstituteForm()">
                <div class="text-center">
                    <div class="bg-yellow-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">📝</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">ครูสอนแทน</h3>
                    <p class="text-gray-600 text-sm">บันทึกผลการสอน</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow cursor-pointer" onclick="showAdminForm()">
                <div class="text-center">
                    <div class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">⚙️</span>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">รองกลุ่มบริหาร</h3>
                    <p class="text-gray-600 text-sm">อนุมัติสุดท้าย</p>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">⚙️ ตั้งค่าระบบ</h2>
                
                <div class="space-y-6">
                    <!-- Google Apps Script URL -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Google Apps Script URL</label>
                        <input type="url" id="scriptUrl" placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">URL ของ Google Apps Script ที่ Deploy แล้ว</p>
                    </div>

                    <!-- Google Sheet ID -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Google Sheet ID</label>
                        <input type="text" id="sheetId" placeholder="137OMps_3meAY5lTwfR-Aq4QhqSn5ul1Eqiz8SjALyf4" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">ID ของ Google Sheet ที่ต้องการบันทึกข้อมูล</p>
                    </div>

                    <!-- Google Drive Folder ID -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Google Drive Folder ID</label>
                        <input type="text" id="folderId" placeholder="1pfSdQHTZwY4VpPtpB7jyLQr4UNFdReEz" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">ID ของโฟลเดอร์ใน Google Drive สำหรับเก็บไฟล์แนบ</p>
                    </div>

                    <!-- Test Connection -->
                    <div class="border-t pt-4">
                        <h3 class="font-semibold text-gray-800 mb-3">ทดสอบการเชื่อมต่อ</h3>
                        <button onclick="testConnection()" id="testBtn" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                            🔗 ทดสอบการเชื่อมต่อ
                        </button>
                        <div id="connectionStatus" class="mt-3"></div>
                    </div>
                </div>

                <div class="flex space-x-4 mt-6">
                    <button onclick="saveSettings()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition-colors">
                        💾 บันทึกการตั้งค่า
                    </button>
                    <button onclick="closeSettings()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-colors">
                        ยกเลิก
                    </button>
                </div>
            </div>
        </div>

        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">เข้าสู่ระบบ</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ประเภทผู้ใช้</label>
                        <select id="userType" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">เลือกประเภทผู้ใช้</option>
                            <option value="teacher">ครูประจำวิชา</option>
                            <option value="head">หัวหน้าสาระ</option>
                            <option value="substitute">ครูสอนแทน</option>
                            <option value="admin">รองกลุ่มบริหารวิชาการ</option>
                        </select>
                    </div>
                    <div id="passwordField" class="hidden">
                        <label class="block text-gray-700 font-medium mb-2">รหัสผ่าน</label>
                        <input type="password" id="password" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="login()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                            เข้าสู่ระบบ
                        </button>
                        <button onclick="closeLogin()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 rounded-lg transition-colors">
                            ยกเลิก
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Form -->
        <div id="teacherForm" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">👨‍🏫 ครูประจำวิชา - มอบหมายงานสอนแทน</h2>
                
                <form id="teacherAssignmentForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">วันที่สอนแทน</label>
                            <input type="date" id="teachingDate" required 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">เวลา</label>
                            <input type="text" id="teachingTime" required placeholder="เช่น 08:30-09:20 หรือ คาบ 1-2"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ชั้น/ห้อง</label>
                            <input type="text" id="classRoom" required placeholder="เช่น ม.1/1" 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">วิชา</label>
                            <input type="text" id="subject" required placeholder="เช่น คณิตศาสตร์" 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ครูประจำวิชา</label>
                            <input type="text" id="regularTeacher" required placeholder="ชื่อครูประจำวิชา" 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">ครูสอนแทน</label>
                            <input type="text" id="substituteTeacher" required placeholder="ชื่อครูสอนแทน" 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">เนื้อหาที่สอน</label>
                        <textarea id="content" required rows="3" placeholder="ระบุเนื้อหาที่ต้องการให้สอน" 
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">กิจกรรมการเรียนการสอน</label>
                        <textarea id="activities" rows="3" placeholder="กิจกรรมหรือวิธีการสอน" 
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">การบ้าน (ถ้ามี)</label>
                        <textarea id="homework" rows="2" placeholder="การบ้านที่มอบหมาย" 
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ไฟล์แนบ (เอกสารประกอบการสอน)</label>
                        <input type="file" id="attachmentFiles" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.png" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">รองรับไฟล์: PDF, Word, PowerPoint, รูปภาพ</p>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">ลายเซ็นครูประจำวิชา</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-50">
                            <canvas id="teacherSignaturePad" width="600" height="200" 
                                    class="signature-pad w-full bg-white rounded cursor-crosshair border-2 border-blue-300"></canvas>
                            <div class="flex justify-center space-x-2 mt-3">
                                <button type="button" onclick="clearSignature('teacherSignaturePad')" 
                                        class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                    🗑️ ลบลายเซ็น
                                </button>
                                <button type="button" onclick="testSignature()" 
                                        class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    ✏️ ทดสอบเซ็น
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">คลิกและลากเพื่อเซ็นชื่อ (รองรับเมาส์และสัมผัส)</p>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition-colors">
                            บันทึกข้อมูล
                        </button>
                        <button type="button" onclick="backToMenu()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg transition-colors">
                            กลับ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Head Form -->
        <div id="headForm" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">👩‍💼 หัวหน้าสาระ - พิจารณาอนุมัติ</h2>
                <div id="headRecordsList">
                    <!-- Records will be loaded here -->
                </div>
                <button onclick="backToMenu()" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">กลับ</button>
            </div>
        </div>

        <!-- Substitute Form -->
        <div id="substituteForm" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">📝 ครูสอนแทน - บันทึกผลการสอน</h2>
                <div id="substituteRecordsList">
                    <!-- Records will be loaded here -->
                </div>
                <button onclick="backToMenu()" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">กลับ</button>
            </div>
        </div>

        <!-- Admin Form -->
        <div id="adminForm" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">⚙️ รองกลุ่มบริหาร - อนุมัติสุดท้าย</h2>
                <div id="adminRecordsList">
                    <!-- Records will be loaded here -->
                </div>
                <button onclick="backToMenu()" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">กลับ</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">📊 แดชบอร์ด</h2>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-100 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 text-sm font-medium">รวมทั้งหมด</p>
                                <p class="text-2xl font-bold text-blue-800" id="totalRecords">0</p>
                            </div>
                            <div class="text-blue-600 text-3xl">📋</div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-100 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-600 text-sm font-medium">รออนุมัติ</p>
                                <p class="text-2xl font-bold text-yellow-800" id="pendingRecords">0</p>
                            </div>
                            <div class="text-yellow-600 text-3xl">⏳</div>
                        </div>
                    </div>
                    
                    <div class="bg-green-100 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 text-sm font-medium">อนุมัติแล้ว</p>
                                <p class="text-2xl font-bold text-green-800" id="approvedRecords">0</p>
                            </div>
                            <div class="text-green-600 text-3xl">✅</div>
                        </div>
                    </div>
                    
                    <div class="bg-red-100 rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-600 text-sm font-medium">ไม่อนุมัติ</p>
                                <p class="text-2xl font-bold text-red-800" id="rejectedRecords">0</p>
                            </div>
                            <div class="text-red-600 text-3xl">❌</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Records -->
                <div class="bg-gray-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">รายการล่าสุด</h3>
                    <div id="recentRecords">
                        <p class="text-gray-500">ไม่มีข้อมูล</p>
                    </div>
                </div>

                <button onclick="backToMenu()" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">กลับ</button>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        var currentUser = null;
        var records = [];
        var appConfig = {
            scriptUrl: 'https://script.google.com/macros/s/AKfycbxh8eE0eSTzD6rSyXE2cRVpXjU7hTBJ9IuiCI1lG_07CbTHRr0oROC3x2t4aeGjlJf-/exec',
            sheetId: '137OMps_3meAY5lTwfR-Aq4QhqSn5ul1Eqiz8SjALyf4',
            folderId: '1pfSdQHTZwY4VpPtpB7jyLQr4UNFdReEz'
        };

        // Utility functions
        function showNotification(message, type, duration) {
            type = type || 'info';
            duration = duration || 5000;
            
            var notification = document.createElement('div');
            notification.className = 'notification ' + type;
            
            var closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.className = 'ml-4 text-white hover:text-gray-200 text-xl';
            closeBtn.onclick = function() { notification.remove(); };
            
            var messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-center justify-between';
            messageDiv.innerHTML = '<span>' + message + '</span>';
            messageDiv.appendChild(closeBtn);
            
            notification.appendChild(messageDiv);
            document.body.appendChild(notification);
            
            setTimeout(function() { notification.classList.add('show'); }, 100);
            
            setTimeout(function() {
                notification.classList.remove('show');
                setTimeout(function() {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        function hideAllSections() {
            var sections = ['menuSection', 'teacherForm', 'headForm', 'substituteForm', 'adminForm', 'dashboard'];
            for (var i = 0; i < sections.length; i++) {
                document.getElementById(sections[i]).classList.add('hidden');
            }
        }

        function showSection(sectionId) {
            hideAllSections();
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function backToMenu() {
            showSection('menuSection');
        }

        // Navigation functions
        function showTeacherForm() {
            showSection('teacherForm');
        }

        function showHeadForm() {
            loadHeadRecords();
            showSection('headForm');
        }

        function showSubstituteForm() {
            loadSubstituteRecords();
            showSection('substituteForm');
        }

        function showAdminForm() {
            // Double check authentication for admin access
            if (currentUser !== 'admin') {
                showNotification('คุณไม่มีสิทธิ์เข้าถึงส่วนนี้ กรุณาเข้าสู่ระบบด้วยบัญชีรองกลุ่มบริหาร', 'error');
                showLogin();
                return;
            }
            
            // Additional verification prompt
            var confirmAccess = confirm('ยืนยันการเข้าถึงระบบรองกลุ่มบริหาร\nการดำเนินการในส่วนนี้จะส่งผลต่อการอนุมัติขั้นสุดท้าย');
            if (!confirmAccess) {
                backToMenu();
                return;
            }
            
            loadAdminRecords();
            showSection('adminForm');
        }

        function showDashboard() {
            loadDashboardData();
            showSection('dashboard');
        }

        // Settings functions
        function loadSettings() {
            var savedConfig = localStorage.getItem('appConfig');
            if (savedConfig) {
                var saved = JSON.parse(savedConfig);
                appConfig.scriptUrl = saved.scriptUrl || appConfig.scriptUrl;
                appConfig.sheetId = saved.sheetId || appConfig.sheetId;
                appConfig.folderId = saved.folderId || appConfig.folderId;
            }
            
            document.getElementById('scriptUrl').value = appConfig.scriptUrl;
            document.getElementById('sheetId').value = appConfig.sheetId;
            document.getElementById('folderId').value = appConfig.folderId;
        }

        function saveSettings() {
            appConfig.scriptUrl = document.getElementById('scriptUrl').value.trim();
            appConfig.sheetId = document.getElementById('sheetId').value.trim();
            appConfig.folderId = document.getElementById('folderId').value.trim();
            
            if (!appConfig.scriptUrl) {
                showNotification('กรุณาใส่ Google Apps Script URL', 'error');
                return;
            }
            
            localStorage.setItem('appConfig', JSON.stringify(appConfig));
            showNotification('บันทึกการตั้งค่าเรียบร้อยแล้ว', 'success');
            closeSettings();
        }

        function showSettings() {
            loadSettings();
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }

        // Test connection
        function testConnection() {
            var testBtn = document.getElementById('testBtn');
            var statusDiv = document.getElementById('connectionStatus');
            
            if (!appConfig.scriptUrl) {
                statusDiv.innerHTML = '<div class="text-red-600">❌ กรุณาใส่ Google Apps Script URL ก่อน</div>';
                return;
            }
            
            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading"></div> กำลังทดสอบ...';
            statusDiv.innerHTML = '<div class="text-blue-600">🔄 กำลังทดสอบการเชื่อมต่อ...</div>';
            
            fetch(appConfig.scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify({
                    action: 'test',
                    timestamp: new Date().toISOString()
                })
            })
            .then(function() {
                statusDiv.innerHTML = '<div class="text-green-600">✅ การเชื่อมต่อสำเร็จ! ระบบพร้อมใช้งาน</div>';
                showNotification('ทดสอบการเชื่อมต่อสำเร็จ', 'success');
            })
            .catch(function(error) {
                console.error('Connection test failed:', error);
                statusDiv.innerHTML = '<div class="text-red-600">❌ การเชื่อมต่อล้มเหลว: ' + error.message + '</div>';
                showNotification('การเชื่อมต่อล้มเหลว กรุณาตรวจสอบ URL', 'error');
            })
            .finally(function() {
                testBtn.disabled = false;
                testBtn.innerHTML = '🔗 ทดสอบการเชื่อมต่อ';
            });
        }

        // Login functions
        function showLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
        }

        function closeLogin() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('flex');
            document.getElementById('userType').value = '';
            document.getElementById('password').value = '';
            document.getElementById('passwordField').classList.add('hidden');
        }

        function login() {
            var userType = document.getElementById('userType').value;
            var password = document.getElementById('password').value;
            
            if (!userType) {
                showNotification('กรุณาเลือกประเภทผู้ใช้', 'error');
                return;
            }
            
            // Check password for restricted users
            if (userType === 'head' && password !== 'head123') {
                showNotification('รหัสผ่านไม่ถูกต้อง', 'error');
                return;
            }
            
            if (userType === 'admin' && password !== 'admin123') {
                showNotification('รหัสผ่านไม่ถูกต้อง', 'error');
                return;
            }
            
            currentUser = userType;
            closeLogin();
            showNotification('เข้าสู่ระบบสำเร็จ', 'success');
            
            // Redirect to appropriate form
            switch(userType) {
                case 'teacher':
                    showTeacherForm();
                    break;
                case 'head':
                    showHeadForm();
                    break;
                case 'substitute':
                    showSubstituteForm();
                    break;
                case 'admin':
                    showAdminForm();
                    break;
            }
        }

        // Signature pad functions
        function initSignaturePad(canvasId) {
            var canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            var ctx = canvas.getContext('2d');
            var isDrawing = false;

            // Set better drawing settings
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;

            function getEventPos(e) {
                var rect = canvas.getBoundingClientRect();
                var scaleX = canvas.width / rect.width;
                var scaleY = canvas.height / rect.height;
                
                var clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                var clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            }

            function startDrawing(e) {
                isDrawing = true;
                var pos = getEventPos(e);
                
                canvas.classList.add('drawing');
                
                // Start new path
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                
                e.preventDefault();
            }

            function draw(e) {
                if (!isDrawing) return;
                
                var pos = getEventPos(e);
                
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                
                e.preventDefault();
            }

            function stopDrawing(e) {
                if (!isDrawing) return;
                isDrawing = false;
                canvas.classList.remove('drawing');
                e.preventDefault();
            }

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Prevent scrolling when touching the canvas
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
            }, { passive: false });
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
        }

        function clearSignature(canvasId) {
            var canvas = document.getElementById(canvasId);
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function testSignature() {
            var canvas = document.getElementById('teacherSignaturePad');
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw sample signature
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(50, 100);
            ctx.lineTo(150, 80);
            ctx.lineTo(200, 120);
            ctx.lineTo(250, 90);
            ctx.lineTo(350, 110);
            ctx.stroke();
            
            showNotification('ทดสอบลายเซ็นเรียบร้อย คุณสามารถลบและเซ็นใหม่ได้', 'info');
        }

        // Teacher form functions
        function submitTeacherForm(e) {
            e.preventDefault();
            
            if (!appConfig.scriptUrl) {
                showNotification('กรุณาตั้งค่า Google Apps Script URL ในเมนูตั้งค่าก่อน', 'error');
                return;
            }

            var formData = {
                id: 'TEACH_' + Date.now(),
                timestamp: new Date().toISOString(),
                date: document.getElementById('teachingDate').value,
                time: document.getElementById('teachingTime').value,
                classRoom: document.getElementById('classRoom').value,
                subject: document.getElementById('subject').value,
                regularTeacher: document.getElementById('regularTeacher').value,
                substituteTeacher: document.getElementById('substituteTeacher').value,
                content: document.getElementById('content').value,
                activities: document.getElementById('activities').value,
                homework: document.getElementById('homework').value,
                status: 'pending',
                createdAt: new Date().toLocaleString('th-TH')
            };

            // Get signature
            var canvas = document.getElementById('teacherSignaturePad');
            var signatureData = canvas.toDataURL();
            
            // Check if signature is not empty - improved detection
            var ctx = canvas.getContext('2d');
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var hasSignature = false;
            
            // Check for any non-white pixels
            for (var i = 0; i < imageData.data.length; i += 4) {
                var r = imageData.data[i];     // red
                var g = imageData.data[i + 1]; // green  
                var b = imageData.data[i + 2]; // blue
                var a = imageData.data[i + 3]; // alpha
                
                // If any pixel is not white (255,255,255) or transparent, there's a signature
                if (a > 0 && (r < 255 || g < 255 || b < 255)) {
                    hasSignature = true;
                    break;
                }
            }
            
            if (!hasSignature) {
                showNotification('กรุณาเซ็นลายเซ็นก่อนส่งข้อมูล', 'error');
                return;
            }

            var submitData = {
                action: 'addRecord',
                data: formData,
                signatures: {
                    teacher: signatureData
                },
                files: [],
                sheetId: appConfig.sheetId,
                folderId: appConfig.folderId
            };

            var submitBtn = document.querySelector('#teacherForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> กำลังบันทึก...';

            fetch(appConfig.scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(submitData)
            })
            .then(function() {
                showNotification('บันทึกข้อมูลสำเร็จ รอการอนุมัติจากหัวหน้าสาระ', 'success');
                document.getElementById('teacherAssignmentForm').reset();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Save to localStorage as backup
                records.push(formData);
                localStorage.setItem('teachingRecords', JSON.stringify(records));
                
                backToMenu();
            })
            .catch(function(error) {
                console.error('Submit failed:', error);
                showNotification('เกิดข้อผิดพลาดในการบันทึก กรุณาลองใหม่', 'error');
            })
            .finally(function() {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'บันทึกข้อมูล';
            });
        }

        // Load records functions
        function loadHeadRecords() {
            var container = document.getElementById('headRecordsList');
            var pendingRecords = records.filter(function(record) {
                return !record.headApproval || record.headApproval === '';
            });
            
            if (pendingRecords.length === 0) {
                container.innerHTML = '<p class="text-gray-600">ไม่มีรายการที่รออนุมัติ</p>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < pendingRecords.length; i++) {
                var record = pendingRecords[i];
                html += '<div class="record-card status-pending mb-6">';
                html += '<h4 class="font-semibold text-gray-800">วิชา: ' + record.subject + '</h4>';
                html += '<p>ชั้น: ' + record.classRoom + ' | วันที่: ' + record.date + ' | เวลา: ' + record.time + '</p>';
                html += '<p>ครูประจำ: ' + record.regularTeacher + ' | ครูสอนแทน: ' + record.substituteTeacher + '</p>';
                html += '<p>เนื้อหา: ' + record.content + '</p>';
                
                // Add signature area for head approval
                html += '<div class="mt-4 border-t pt-4">';
                html += '<h5 class="font-medium text-gray-700 mb-2">ลายเซ็นหัวหน้าสาระ (สำหรับการอนุมัติ)</h5>';
                html += '<canvas id="headSignature_' + record.id + '" width="400" height="120" ';
                html += 'class="signature-pad w-full bg-white rounded cursor-crosshair border-2 border-green-300 mb-2"></canvas>';
                html += '<div class="flex space-x-2 mb-4">';
                html += '<button onclick="clearSignature(\'headSignature_' + record.id + '\')" ';
                html += 'class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ลบลายเซ็น</button>';
                html += '</div>';
                html += '</div>';
                
                html += '<div class="mt-4 space-x-2">';
                html += '<button onclick="approveRecordWithSignature(\'' + record.id + '\')" class="bg-green-600 text-white px-4 py-2 rounded">อนุมัติ</button>';
                html += '<button onclick="rejectRecord(\'' + record.id + '\')" class="bg-red-600 text-white px-4 py-2 rounded">ไม่อนุมัติ</button>';
                html += '</div>';
                html += '</div>';
            }
            container.innerHTML = html;
            
            // Initialize signature pads for each record after a short delay
            setTimeout(function() {
                for (var i = 0; i < pendingRecords.length; i++) {
                    initSignaturePad('headSignature_' + pendingRecords[i].id);
                }
            }, 100);
        }

        function loadSubstituteRecords() {
            var container = document.getElementById('substituteRecordsList');
            var approvedRecords = records.filter(function(record) {
                return record.headApproval === 'approved';
            });
            
            if (approvedRecords.length === 0) {
                container.innerHTML = '<p class="text-gray-600">ไม่มีรายการที่ต้องบันทึก</p>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < approvedRecords.length; i++) {
                var record = approvedRecords[i];
                html += '<div class="record-card status-approved">';
                html += '<h4 class="font-semibold text-gray-800">วิชา: ' + record.subject + '</h4>';
                html += '<p>ชั้น: ' + record.classRoom + ' | วันที่: ' + record.date + ' | เวลา: ' + record.time + '</p>';
                html += '<p>ครูประจำ: ' + record.regularTeacher + ' | ครูสอนแทน: ' + record.substituteTeacher + '</p>';
                html += '<p>เนื้อหา: ' + record.content + '</p>';
                if (!record.substituteReport) {
                    html += '<div class="mt-4">';
                    html += '<button onclick="showSubstituteReportForm(\'' + record.id + '\')" class="bg-blue-600 text-white px-4 py-2 rounded">บันทึกผลการสอน</button>';
                    html += '</div>';
                } else {
                    html += '<div class="mt-2 p-3 bg-green-50 rounded">';
                    html += '<p class="text-green-800">✅ บันทึกผลการสอนแล้ว</p>';
                    html += '</div>';
                }
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function loadAdminRecords() {
            var container = document.getElementById('adminRecordsList');
            var readyRecords = records.filter(function(record) {
                return record.headApproval === 'approved' && record.substituteReport && !record.adminApproval;
            });
            
            if (readyRecords.length === 0) {
                container.innerHTML = '<p class="text-gray-600">ไม่มีรายการที่รอการอนุมัติ</p>';
                return;
            }
            
            var html = '';
            for (var i = 0; i < readyRecords.length; i++) {
                var record = readyRecords[i];
                html += '<div class="record-card status-pending mb-6">';
                html += '<h4 class="font-semibold text-gray-800">วิชา: ' + record.subject + '</h4>';
                html += '<p>ชั้น: ' + record.classRoom + ' | วันที่: ' + record.date + ' | เวลา: ' + record.time + '</p>';
                html += '<p>ครูประจำ: ' + record.regularTeacher + ' | ครูสอนแทน: ' + record.substituteTeacher + '</p>';
                html += '<p>เนื้อหา: ' + record.content + '</p>';
                
                // Show substitute report if available
                if (record.substituteReport) {
                    html += '<div class="mt-3 p-3 bg-blue-50 rounded">';
                    html += '<h6 class="font-medium text-blue-800">รายงานครูสอนแทน</h6>';
                    html += '<p>จำนวนนักเรียน: ' + record.substituteReport.attendance + '</p>';
                    html += '<p>พฤติกรรม: ' + record.substituteReport.behavior + '</p>';
                    if (record.substituteReport.observations) {
                        html += '<p>ข้อสังเกต: ' + record.substituteReport.observations + '</p>';
                    }
                    html += '</div>';
                }
                
                // Add reason input field with stricter requirements
                html += '<div class="mt-4 border-t pt-4 bg-red-50 p-4 rounded">';
                html += '<h5 class="font-semibold text-red-800 mb-2">⚠️ ข้อมูลจำเป็นสำหรับการอนุมัติ</h5>';
                html += '<label class="block text-gray-700 font-medium mb-2">เหตุผลในการพิจารณา (บังคับกรอก)</label>';
                html += '<textarea id="adminReason_' + record.id + '" rows="3" placeholder="กรุณาระบุเหตุผลที่ชัดเจนในการอนุมัติหรือไม่อนุมัติ (ข้อมูลนี้จำเป็นและจะถูกบันทึก)" ';
                html += 'class="w-full border-2 border-red-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 mb-3" required></textarea>';
                html += '<p class="text-sm text-red-600">* กรุณากรอกเหตุผลอย่างน้อย 10 ตัวอักษร</p>';
                html += '</div>';
                
                // Add signature area for admin approval with emphasis
                html += '<div class="mt-4 bg-purple-50 p-4 rounded">';
                html += '<h5 class="font-semibold text-purple-800 mb-2">📝 ลายเซ็นรองกลุ่มบริหาร (บังคับ)</h5>';
                html += '<canvas id="adminSignature_' + record.id + '" width="400" height="120" ';
                html += 'class="signature-pad w-full bg-white rounded cursor-crosshair border-3 border-purple-400 mb-2"></canvas>';
                html += '<div class="flex space-x-2 mb-2">';
                html += '<button onclick="clearSignature(\'adminSignature_' + record.id + '\')" ';
                html += 'class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">ลบลายเซ็น</button>';
                html += '</div>';
                html += '<p class="text-sm text-purple-600">* ลายเซ็นจำเป็นสำหรับการยืนยันตัวตนและรับผิดชอบการตัดสินใจ</p>';
                html += '</div>';
                
                html += '<div class="mt-6 space-x-2">';
                html += '<button onclick="finalApproveWithSignature(\'' + record.id + '\')" class="bg-green-600 text-white px-6 py-3 rounded font-semibold hover:bg-green-700">✅ อนุมัติขั้นสุดท้าย</button>';
                html += '<button onclick="finalRejectWithSignature(\'' + record.id + '\')" class="bg-red-600 text-white px-6 py-3 rounded font-semibold hover:bg-red-700">❌ ไม่อนุมัติ</button>';
                html += '</div>';
                html += '</div>';
            }
            container.innerHTML = html;
            
            // Initialize signature pads for each record after a short delay
            setTimeout(function() {
                for (var i = 0; i < readyRecords.length; i++) {
                    initSignaturePad('adminSignature_' + readyRecords[i].id);
                }
            }, 100);
        }

        // Data loading functions from Google Sheets
        function loadRecordsFromSheet() {
            if (!appConfig.scriptUrl) {
                console.log('No script URL configured, using localStorage only');
                return;
            }

            var requestData = {
                action: 'getRecords',
                sheetId: appConfig.sheetId
            };

            fetch(appConfig.scriptUrl, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: JSON.stringify(requestData)
            })
            .then(function(response) {
                // Note: Due to no-cors mode, we can't read the response
                // The data will be stored in Google Sheets
                console.log('Request sent to load records from Google Sheets');
            })
            .catch(function(error) {
                console.error('Failed to load records from Google Sheets:', error);
            });
        }

        function loadDashboardData() {
            // First load from localStorage
            var localRecords = JSON.parse(localStorage.getItem('teachingRecords') || '[]');
            
            // Try to get fresh data from Google Sheets
            if (appConfig.scriptUrl) {
                var requestData = {
                    action: 'getStatistics',
                    sheetId: appConfig.sheetId
                };

                fetch(appConfig.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(requestData)
                })
                .then(function() {
                    console.log('Statistics request sent to Google Sheets');
                })
                .catch(function(error) {
                    console.error('Failed to get statistics from Google Sheets:', error);
                });
            }

            // Use local data for display
            updateDashboardDisplay(localRecords);
        }

        function updateDashboardDisplay(records) {
            var total = records.length;
            var pending = records.filter(function(r) { 
                return r.status === 'pending' || (!r.headApproval && !r.adminApproval); 
            }).length;
            var approved = records.filter(function(r) { 
                return r.adminApproval === 'approved' || r.status === 'completed'; 
            }).length;
            var rejected = records.filter(function(r) { 
                return r.adminApproval === 'rejected' || r.headApproval === 'rejected' || r.status === 'rejected'; 
            }).length;
            
            // Update statistics display
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('pendingRecords').textContent = pending;
            document.getElementById('approvedRecords').textContent = approved;
            document.getElementById('rejectedRecords').textContent = rejected;
            
            // Update recent records
            var recentContainer = document.getElementById('recentRecords');
            if (total === 0) {
                recentContainer.innerHTML = '<p class="text-gray-500">ไม่มีข้อมูล</p>';
                return;
            }
            
            var recentRecords = records.slice(-5).reverse();
            var html = '';
            for (var i = 0; i < recentRecords.length; i++) {
                var record = recentRecords[i];
                var statusText = getStatusText(record);
                var statusClass = getStatusClass(record);
                
                html += '<div class="record-card ' + statusClass + '">';
                html += '<div class="flex justify-between items-start">';
                html += '<div>';
                html += '<h4 class="font-semibold text-gray-800">' + (record.subject || 'ไม่ระบุวิชา') + ' - ' + (record.classRoom || 'ไม่ระบุห้อง') + '</h4>';
                html += '<p>ครูประจำ: ' + (record.regularTeacher || 'ไม่ระบุ') + ' | วันที่: ' + (record.date || 'ไม่ระบุ') + '</p>';
                html += '<span class="inline-block px-2 py-1 text-xs rounded ' + getStatusBadgeClass(record) + '">';
                html += statusText;
                html += '</span>';
                html += '</div>';
                
                // Add PDF button for completed records
                if (record.status === 'completed' && record.adminApproval === 'approved') {
                    html += '<div>';
                    html += '<button onclick="generatePDF(\'' + record.id + '\')" ';
                    html += 'class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">';
                    html += '📄 พิมพ์ PDF';
                    html += '</button>';
                    html += '</div>';
                }
                
                html += '</div>';
                html += '</div>';
            }
            recentContainer.innerHTML = html;
        }

        function getStatusText(record) {
            if (record.adminApproval === 'approved' || record.status === 'completed') {
                return 'อนุมัติแล้ว';
            } else if (record.adminApproval === 'rejected' || record.headApproval === 'rejected' || record.status === 'rejected') {
                return 'ไม่อนุมัติ';
            } else if (record.headApproval === 'approved') {
                return 'รอการอนุมัติจากรอง';
            } else {
                return 'รอการอนุมัติ';
            }
        }

        function getStatusClass(record) {
            if (record.adminApproval === 'approved' || record.status === 'completed') {
                return 'status-approved';
            } else if (record.adminApproval === 'rejected' || record.headApproval === 'rejected' || record.status === 'rejected') {
                return 'status-rejected';
            } else {
                return 'status-pending';
            }
        }

        function getStatusBadgeClass(record) {
            if (record.adminApproval === 'approved' || record.status === 'completed') {
                return 'bg-green-100 text-green-800';
            } else if (record.adminApproval === 'rejected' || record.headApproval === 'rejected' || record.status === 'rejected') {
                return 'bg-red-100 text-red-800';
            } else {
                return 'bg-yellow-100 text-yellow-800';
            }
        }

        // Record action functions
        function approveRecord(recordId) {
            var record = records.find(function(r) { return r.id === recordId; });
            if (record) {
                record.headApproval = 'approved';
                record.headReason = 'อนุมัติโดยหัวหน้าสาระ';
                localStorage.setItem('teachingRecords', JSON.stringify(records));
                showNotification('อนุมัติรายการเรียบร้อย', 'success');
                loadHeadRecords();
            }
        }

        function approveRecordWithSignature(recordId) {
            var canvas = document.getElementById('headSignature_' + recordId);
            if (!canvas) {
                showNotification('ไม่พบพื้นที่ลายเซ็น', 'error');
                return;
            }

            // Check if signature exists
            var ctx = canvas.getContext('2d');
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var hasSignature = false;
            
            for (var i = 0; i < imageData.data.length; i += 4) {
                var r = imageData.data[i];
                var g = imageData.data[i + 1];
                var b = imageData.data[i + 2];
                var a = imageData.data[i + 3];
                
                if (a > 0 && (r < 255 || g < 255 || b < 255)) {
                    hasSignature = true;
                    break;
                }
            }
            
            if (!hasSignature) {
                showNotification('กรุณาเซ็นลายเซ็นก่อนอนุมัติ', 'error');
                return;
            }

            var signatureData = canvas.toDataURL();
            
            // Find and update the record
            for (var i = 0; i < records.length; i++) {
                if (records[i].id === recordId) {
                    records[i].headApproval = 'approved';
                    records[i].headReason = 'อนุมัติโดยหัวหน้าสาระพร้อมลายเซ็น';
                    records[i].headSignature = signatureData;
                    records[i].status = 'head_approved';
                    break;
                }
            }
            
            // Update localStorage immediately
            localStorage.setItem('teachingRecords', JSON.stringify(records));
            
            // Send update to Google Sheet
            if (appConfig.scriptUrl) {
                var updateData = {
                    action: 'updateRecord',
                    recordId: recordId,
                    updateData: {
                        headApproval: 'approved',
                        headReason: 'อนุมัติโดยหัวหน้าสาระพร้อมลายเซ็น',
                        status: 'head_approved'
                    },
                    headSignature: signatureData,
                    sheetId: appConfig.sheetId,
                    folderId: appConfig.folderId
                };

                fetch(appConfig.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(updateData)
                })
                .then(function() {
                    console.log('Head approval sent to Google Sheet');
                })
                .catch(function(error) {
                    console.error('Failed to send head approval to Google Sheet:', error);
                });
            }
            
            showNotification('อนุมัติรายการเรียบร้อย พร้อมบันทึกลายเซ็น', 'success');
            
            // Reload the head records to update the display
            setTimeout(function() {
                loadHeadRecords();
            }, 500);
        }

        function rejectRecord(recordId) {
            var reason = prompt('เหตุผลที่ไม่อนุมัติ:');
            if (reason) {
                var record = records.find(function(r) { return r.id === recordId; });
                if (record) {
                    record.headApproval = 'rejected';
                    record.headReason = reason;
                    record.status = 'rejected';
                    localStorage.setItem('teachingRecords', JSON.stringify(records));
                    showNotification('ไม่อนุมัติรายการเรียบร้อย', 'success');
                    loadHeadRecords();
                }
            }
        }

        function finalApprove(recordId) {
            var record = records.find(function(r) { return r.id === recordId; });
            if (record) {
                record.adminApproval = 'approved';
                record.adminReason = 'อนุมัติโดยรองกลุ่มบริหาร';
                record.status = 'completed';
                localStorage.setItem('teachingRecords', JSON.stringify(records));
                showNotification('อนุมัติขั้นสุดท้ายเรียบร้อย', 'success');
                loadAdminRecords();
            }
        }

        function finalApproveWithSignature(recordId) {
            var reasonTextarea = document.getElementById('adminReason_' + recordId);
            var canvas = document.getElementById('adminSignature_' + recordId);
            
            if (!canvas) {
                showNotification('ไม่พบพื้นที่ลายเซ็น', 'error');
                return;
            }

            var reason = reasonTextarea ? reasonTextarea.value.trim() : '';
            if (!reason) {
                showNotification('กรุณาระบุเหตุผลในการพิจารณา', 'error');
                return;
            }

            // Check if signature exists
            var ctx = canvas.getContext('2d');
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var hasSignature = false;
            
            for (var i = 0; i < imageData.data.length; i += 4) {
                var r = imageData.data[i];
                var g = imageData.data[i + 1];
                var b = imageData.data[i + 2];
                var a = imageData.data[i + 3];
                
                if (a > 0 && (r < 255 || g < 255 || b < 255)) {
                    hasSignature = true;
                    break;
                }
            }
            
            if (!hasSignature) {
                showNotification('กรุณาเซ็นลายเซ็นก่อนอนุมัติ', 'error');
                return;
            }

            var signatureData = canvas.toDataURL();
            
            // Find and update the record
            for (var i = 0; i < records.length; i++) {
                if (records[i].id === recordId) {
                    records[i].adminApproval = 'approved';
                    records[i].adminReason = reason;
                    records[i].adminSignature = signatureData;
                    records[i].status = 'completed';
                    break;
                }
            }
            
            // Update localStorage immediately
            localStorage.setItem('teachingRecords', JSON.stringify(records));
            
            // Send update to Google Sheet
            if (appConfig.scriptUrl) {
                var updateData = {
                    action: 'updateRecord',
                    recordId: recordId,
                    updateData: {
                        adminApproval: 'approved',
                        adminReason: reason,
                        status: 'completed'
                    },
                    adminSignature: signatureData,
                    sheetId: appConfig.sheetId,
                    folderId: appConfig.folderId
                };

                fetch(appConfig.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(updateData)
                })
                .then(function() {
                    console.log('Admin approval sent to Google Sheet');
                })
                .catch(function(error) {
                    console.error('Failed to send admin approval to Google Sheet:', error);
                });
            }
            
            showNotification('อนุมัติขั้นสุดท้ายเรียบร้อย พร้อมบันทึกลายเซ็น', 'success');
            
            // Reload the admin records to update the display
            setTimeout(function() {
                loadAdminRecords();
            }, 500);
        }

        function finalReject(recordId) {
            var reason = prompt('เหตุผลที่ไม่อนุมัติ:');
            if (reason) {
                var record = records.find(function(r) { return r.id === recordId; });
                if (record) {
                    record.adminApproval = 'rejected';
                    record.adminReason = reason;
                    record.status = 'rejected';
                    localStorage.setItem('teachingRecords', JSON.stringify(records));
                    showNotification('ไม่อนุมัติรายการเรียบร้อย', 'success');
                    loadAdminRecords();
                }
            }
        }

        function finalRejectWithSignature(recordId) {
            var reasonTextarea = document.getElementById('adminReason_' + recordId);
            var canvas = document.getElementById('adminSignature_' + recordId);
            
            if (!canvas) {
                showNotification('ไม่พบพื้นที่ลายเซ็น', 'error');
                return;
            }

            var reason = reasonTextarea ? reasonTextarea.value.trim() : '';
            if (!reason) {
                showNotification('กรุณาระบุเหตุผลในการพิจารณา', 'error');
                return;
            }

            // Check if signature exists
            var ctx = canvas.getContext('2d');
            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var hasSignature = false;
            
            for (var i = 0; i < imageData.data.length; i += 4) {
                var r = imageData.data[i];
                var g = imageData.data[i + 1];
                var b = imageData.data[i + 2];
                var a = imageData.data[i + 3];
                
                if (a > 0 && (r < 255 || g < 255 || b < 255)) {
                    hasSignature = true;
                    break;
                }
            }
            
            if (!hasSignature) {
                showNotification('กรุณาเซ็นลายเซ็นก่อนไม่อนุมัติ', 'error');
                return;
            }

            var signatureData = canvas.toDataURL();
            
            // Find and update the record
            for (var i = 0; i < records.length; i++) {
                if (records[i].id === recordId) {
                    records[i].adminApproval = 'rejected';
                    records[i].adminReason = reason;
                    records[i].adminSignature = signatureData;
                    records[i].status = 'rejected';
                    break;
                }
            }
            
            // Update localStorage immediately
            localStorage.setItem('teachingRecords', JSON.stringify(records));
            
            // Send update to Google Sheet
            if (appConfig.scriptUrl) {
                var updateData = {
                    action: 'updateRecord',
                    recordId: recordId,
                    updateData: {
                        adminApproval: 'rejected',
                        adminReason: reason,
                        status: 'rejected'
                    },
                    adminSignature: signatureData,
                    sheetId: appConfig.sheetId,
                    folderId: appConfig.folderId
                };

                fetch(appConfig.scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(updateData)
                })
                .then(function() {
                    console.log('Admin rejection sent to Google Sheet');
                })
                .catch(function(error) {
                    console.error('Failed to send admin rejection to Google Sheet:', error);
                });
            }
            
            showNotification('บันทึกการไม่อนุมัติเรียบร้อย พร้อมบันทึกลายเซ็น', 'success');
            
            // Reload the admin records to update the display
            setTimeout(function() {
                loadAdminRecords();
            }, 500);
        }

        function showSubstituteReportForm(recordId) {
            var attendance = prompt('จำนวนนักเรียนที่เข้าเรียน:');
            var behavior = prompt('พฤติกรรมของนักเรียน:');
            var observations = prompt('ข้อสังเกตเพิ่มเติม:');
            
            if (attendance && behavior) {
                var record = records.find(function(r) { return r.id === recordId; });
                if (record) {
                    record.substituteReport = {
                        attendance: attendance,
                        behavior: behavior,
                        observations: observations || '',
                        submittedAt: new Date().toLocaleString('th-TH')
                    };
                    localStorage.setItem('teachingRecords', JSON.stringify(records));
                    showNotification('บันทึกผลการสอนเรียบร้อย', 'success');
                    loadSubstituteRecords();
                }
            }
        }

        // User type change handler
        document.getElementById('userType').addEventListener('change', function() {
            var userType = this.value;
            var passwordField = document.getElementById('passwordField');
            
            if (userType === 'head' || userType === 'admin') {
                passwordField.classList.remove('hidden');
            } else {
                passwordField.classList.add('hidden');
            }
        });

        // Teacher form submit handler
        document.getElementById('teacherAssignmentForm').addEventListener('submit', submitTeacherForm);

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing teaching substitute system...');
            
            // Initialize signature pad
            initSignaturePad('teacherSignaturePad');
            
            // Load settings and records
            loadSettings();
            records = JSON.parse(localStorage.getItem('teachingRecords') || '[]');
            
            // Try to load fresh data from Google Sheets
            loadRecordsFromSheet();
            
            // Show menu by default
            showSection('menuSection');
            
            // Show setup notification if no script URL configured
            if (!appConfig.scriptUrl || appConfig.scriptUrl.includes('YOUR_DEPLOYMENT_ID')) {
                setTimeout(function() {
                    showNotification('กรุณาตั้งค่า Google Apps Script URL ในเมนูตั้งค่า เพื่อเชื่อมต่อกับ Google Sheets', 'info', 10000);
                }, 2000);
            }
            
            console.log('Application initialized successfully');
            console.log('Records loaded:', records.length);
        });
    </script>
</body>
</html>
